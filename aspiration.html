<head>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      color: #333;
      font-weight: 300;
      font-size: 20px;
      padding: 3em 1em;
      background: #eee;
    }
    h1 {
      font-size: 1em;
      margin: 0 0 2em;
      font-weight: normal;
      text-align: center;
    }
    section {
      width: 50vw;
      margin-left: auto;
      margin-right: auto;
    }
    section * {
      cursor: default;
    }
    section > div {
      position: relative;
      background: #fff;
      padding: .5em .75em;
      overflow: hidden;
      white-space: nowrap;
    }
    section > div:not(:last-child) {
      margin-bottom: 1em;
    }
    section > div > div::before {
      display: block;
      content: attr(data-url);
      margin-bottom: .3em;
      max-width: 100%;
      padding-right: .25em; /* Workaround apparent webkit bug with text-overflow ellipsis cropping the ... */
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: .3;
      transition: opacity .2s ease;
    }
    section > div:hover > div::before {
      opacity: .7;
    }
  </style>
</head>
<body>
  <h1>⟷ &nbsp; Resize the page</h1>
  <section>
    <div><div data-url="https://example.com/sha1a2b3c4d5c6d/human/readable/path#hash"></div></div>
    <div><div data-url="https://www.super-long-domain-example.com/with-simple-path"></div></div>
    <div><div data-url="https://random.subdomains.example.com/with-simple-path"></div></div>
    <div><div data-url="https://sub-domain.domain.com/sha1a2b3c4d5e/human-readable-path?ref=g1bb3r1s3hhh&page=10"></div></div>
    <div><div data-url="https://and.now.for.some.real.examples.com"></div></div>
    <div><div data-url="https://blog.cloudflare.com/cloudflare-acquires-eager/"></div></div>
    <div><div data-url="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/split"></div></div>
    <div><div data-url="http://youmightnotneedjquery.com/#effects"></div></div>
    <div><div data-url="https://www.google.com/search?q=regex+string+is+a+word&amp;start=20&amp;rlz=1C5CHFA_enUS7Math.22US722&amp;biw=1440&amp;bih=799"></div></div>
  </section>
  <script>
    var isWordedPart = function(str) {
      // TODO - better regexes
      var wordRe = /^(([a-z]*?[aeiouy][a-z]*?)|(\d*)|q)$/i;
      var acronymRe = /^([a-z]{2,5}|[A-Z]{2,5})$/;
      var split = str.split(/-|\.|,|\+|_|%20/);

      for (var i = 0; i < split.length; i++) {
        if (!wordRe.test(split[i]) && !acronymRe.test(split[i])) {
          return false;
        }
      }

      return true;
    };

    var collapseAdjacentEllipsizedParams = function(str) {
      var originalStr = str;

      // TODO - combine/simplifiy
      var str = str.replace(/&\.\.\.&\.\.\.&/g, '&...&')
      var str = str.replace(/\.\.\.&\.\.\.&/g, '...&')
      var str = str.replace(/&\.\.\.&\.\.\./g, '&...')

      if (str.length === originalStr.length) {
        return str;
      } else {
        return collapseAdjacentEllipsizedParams(str);
      }
    };

    // TODO - combine with collapseAdjacentEllipsizedParams
    collapseAdjacentEllipsizedPaths = function(str) {
      var originalStr = str;

      // TODO - combine/simplifiy
      var str = str.replace(/\/\.\.\.\/\.\.\.\//g, '/.../')
      var str = str.replace(/\.\.\.\/\.\.\.\//g, '.../')
      var str = str.replace(/\/\.\.\.\/\.\.\./g, '/...')

      if (str.length === originalStr.length) {
        return str;
      } else {
        return collapseAdjacentEllipsizedPaths(str);
      }
    };

    var shorteners = [
      // Remove protocol
      function(url) {
        return url.replace(/^https?\:\/?\/?/i, '');
      }
      ,
      // Remove www.
      function(url) {
        return url.replace(/^www\./, '');
      }
      ,
      // Remove port
      function(url) {
        var urlSlashSplit = url.split('/');
        var domain = urlSlashSplit[0];
        urlSlashSplit[0] = domain.split(':')[0];
        return urlSlashSplit.join('/');
      }
      ,
      // Remove non-human bits past the query
      function(url, maxLength) {
        var indexOfQuestionMark = url.indexOf('?');
        if (indexOfQuestionMark < 0) {
          return url;
        }

        var beforeQuery = url.substr(0, indexOfQuestionMark);
        var query = url.substr(indexOfQuestionMark + 1);

        var indexOfHash = query.indexOf('#');
        var hash = '';
        var queryBeforeHash = query;
        if (indexOfHash > -1) {
          var queryBeforeHash = query.substr(0, indexOfHash);
          var hash = query.substr(indexOfHash);
        }

        var queryParts = queryBeforeHash.split('&');
        for (var i = 0; i < queryParts.length; i++) {
          var paramPair = queryParts[i].split('=');

          // TODO - write simpler
          if (!isWordedPart(paramPair[0]) && (paramPair.length > 1 && !isWordedPart(paramPair[1]))) {
            queryParts[i] = '...';
          }

          // TODO - write simpler
          else if (!isWordedPart(paramPair[0]) && (paramPair.length > 1 && isWordedPart(paramPair[1]))) {
            queryParts[i] = '...=' + paramPair[1];
          }

          // TODO - write simpler
          else if (isWordedPart(paramPair[0]) && (paramPair.length > 1 && !isWordedPart(paramPair[1]))) {
            queryParts[i] = paramPair[0] + '=...';
          }
        }

        query = queryParts.join('&');
        return beforeQuery + '?' + collapseAdjacentEllipsizedParams(query) + hash;
      }
      ,
      // Remove non-human bits in path
      // TODO - treat file.ext differently than /paths/ between two /
      function(url, maxLength) {
        var indexOfSlash = url.indexOf('/');
        if (indexOfSlash < 0) {
          return url;
        }

        var beforeSlash = url.substr(0, indexOfSlash);
        var afterSlash = url.substr(indexOfSlash + 1);

        var indexOfQuery = afterSlash.indexOf('?');
        var indexOfHash = afterSlash.indexOf('#');

        var afterSlashSuffix = '';
        var afterSlashBeforeSuffix = afterSlash;
        if (indexOfQuery > -1 || indexOfHash > -1) {
          var indexOfSuffix = indexOfQuery !== -1 ? indexOfQuery : indexOfHash;
          if (indexOfQuery > -1 && indexOfHash > -1) {
            indexOfSuffix = indexOfQuery < indexOfHash ? indexOfQuery : indexOfHash;
          }
          afterSlashBeforeSuffix = afterSlash.substr(0, indexOfSuffix);
          afterSlashSuffix = afterSlash.substr(indexOfSuffix);
        }

        var pathParts = afterSlashBeforeSuffix.split('/')
        for (var i = 0; i < pathParts.length; i++) {
          if (!isWordedPart(pathParts[i])) {
            pathParts[i] = '...';
          }
        }

        afterSlash = pathParts.join('/');
        return beforeSlash + '/' + collapseAdjacentEllipsizedPaths(afterSlash) + afterSlashSuffix;
      }
      ,
      // Ellipsize domain parts
      function(url, maxLength) {
        var urlSlashSplit = url.split('/');
        var domain = urlSlashSplit[0];
        var domainParts = domain.split('.');
        var longestDomainPart = '';
        var longestDomainPartIndex = -1;
        var domainEllipsis = '[...]';

        for (var i = 0; i < domainParts.length; i++) {
          if (domainParts[i].length > longestDomainPart.length) {
            longestDomainPart = domainParts[i];
            longestDomainPartIndex = i;
          }
        }

        var domainMaxLength = maxLength - (url.length - longestDomainPart.length);
        if (url.length - longestDomainPart.length > domainMaxLength) {
          domainMaxLength = Math.max(domainMaxLength, url.length - longestDomainPart.length);
        }

        var newLongestDomainPart = longestDomainPart.substr(0, domainMaxLength - domainEllipsis.length);
        if (newLongestDomainPart === longestDomainPart) {
          return url;
        }

        domainParts[longestDomainPartIndex] = newLongestDomainPart + domainEllipsis;
        urlSlashSplit[0] = domainParts.join('.');
        return urlSlashSplit.join('/');
      }
      ,
      // Prioritize main domain and TLD over subdomains
      function(url, maxLength) {
        var urlSlashSplit = url.split('/');
        var domain = urlSlashSplit[0];
        var domainParts = domain.split('.');
        var ellipsis = '...';

        // Only treat subdomains
        if (domainParts.length < 3) {
          return url;
        }

        // Don’t run if domain has already been shortened
        if (urlSlashSplit[0].indexOf('[...]') > -1) {
          return url;
        }

        subDomainsPriorToMainDomain = domainParts.slice(0, domainParts.length - 2)
        subDomainsPriorToMainDomainStr = subDomainsPriorToMainDomain.join('.')

        domainAndTLD = domainParts.slice(domainParts.length - 2).join('.')

        //var subDomainMaxLength = maxLength - (url.length - subDomainsPriorToMainDomainStr.length) - 1; // TODO
        var subDomainMaxLength = maxLength - (url.length - subDomainsPriorToMainDomainStr.length) - 1; // TODO

        var newSubDomainsPriorToMainDomainStr = subDomainsPriorToMainDomainStr.substr(subDomainsPriorToMainDomainStr.length - (subDomainMaxLength - ellipsis.length));
        if (newSubDomainsPriorToMainDomainStr === subDomainsPriorToMainDomainStr) {
          return url;
        }

        urlSlashSplit[0] = '...' + newSubDomainsPriorToMainDomainStr + '.' + domainAndTLD;
        return urlSlashSplit.join('/');
      }
      ,
      // Merge ellipsies
      function(url) {
        return url.replace(/(\.){3,}/g, '...');
      }
      ,
      // Finally, just ellipsize
      function(url, maxLength) {
        var url = url.substr(0, maxLength - 3) + '...';
        url = url.replace(/(\.){3,}/g, '...');
        url = url.replace(/\[\.\.\.\]\.\.\.$/g, '...'); // TODO - be smarter
        url = url.replace(/\[\.\.\.$/g, '...'); // TODO - be smarter
        url = url.replace(/(\.){3,}/g, '...'); // TODO - necessary?
        return url;
      }
    ];

    var simpleURL = function(url, maxLength) {
      for (var i = 0; i < shorteners.length; i++) {
        if (url.length > maxLength) {
          url = shorteners[i](url, maxLength);
        }
      }

      return url;
    };

    var renderSimpleURL = function(node) {
      var url = node.getAttribute('data-url');
      var newURL = url;
      var maxLength = url.length;
      var width = node.clientWidth;
      var rightPadding = parseInt(getComputedStyle(node).paddingRight, 10)

      node.textContent = url;
      while (node.scrollWidth - rightPadding > width) {
        maxLength -= 1;
        newURL = simpleURL(url, maxLength);
        node.textContent = newURL;
      }
    };

    var throttle = function(fn, timeout) {
      return function throttledFn() {
        if (!throttledFn.timer) {
          var args = arguments;
          var that = this;

          throttledFn.timer = setTimeout(function() {
            fn.apply(that, args);

            throttledFn.timer = undefined;
          }, timeout);
        }
      };
    };

    var init = function() {
      document.querySelectorAll('div[data-url]').forEach(function(div){
        renderSimpleURL(div);
      });
    };

    init();
    window.addEventListener('resize', throttle(init, 100));
  </script>
</body>
